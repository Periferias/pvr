apiVersion: v1
kind: Secret
metadata:
  name: {{ include "nixpacks-cloudnative-app.fullname" . }}-secret
  labels:
    {{- include "nixpacks-cloudnative-app.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.secrets }}
  {{- range $key, $value := .Values.secrets }}
  {{ $key }}: {{ $value | squote }}
  {{- end }}
  {{- end }}

  # Compute DATABASE_URL if not provided (contains credentials - must be in Secret)
  {{- $dbProvided := and .Values.secrets (hasKey .Values.secrets "DATABASE_URL") }}
  {{- if and (not $dbProvided) .Values.postgresql.enabled }}
  DATABASE_URL: "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ include "nixpacks-cloudnative-app.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}?serverVersion=16&charset=utf8"
  {{- end }}

  # Compute MONGODB_URL if not provided (contains credentials - must be in Secret)
  {{- $mongoUrlProvided := and .Values.secrets (hasKey .Values.secrets "MONGODB_URL") }}
  {{- if and (not $mongoUrlProvided) .Values.mongodb.enabled }}
  {{- $mongoUser := index .Values.mongodb.auth.usernames 0 }}
  {{- $mongoPass := index .Values.mongodb.auth.passwords 0 }}
  MONGODB_URL: "mongodb://{{ $mongoUser }}:{{ $mongoPass }}@{{ include "nixpacks-cloudnative-app.fullname" . }}-mongodb:27017"
  {{- end }}
