name: Kubernetes Deployment Test

on:
  push:
    branches: [ main, feat/* ]
  # pull_request:
  #   branches: [ main ]

jobs:
  deploy:
    name: Test Kubernetes Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: aurora-test
          wait: 120s
          node_image: kindest/node:v1.29.0

      - name: Verify cluster is ready
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Add Helm repositories
        run: |
          helm repo add groundhog2k https://groundhog2k.github.io/helm-charts/
          helm repo update

      - name: Update Helm dependencies
        run: |
          cd helm/pvr
          helm dependency update
          cd ../..

      - name: Install Skaffold
        run: |
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          chmod +x skaffold
          sudo mv skaffold /usr/local/bin/
          skaffold version

      - name: Create test environment file
        run: |
          cat > .env << EOF
          APP_ENV=prod
          APP_SECRET=test-secret-for-ci
          DATABASE_URL="postgresql://example:!ChangeMe!@pvr-postgres:5432/api?serverVersion=16&charset=utf8"
          MONGODB_URI="mongodb://root:!ChangeMe!@pvr-mongodb:27017"
          MONGODB_DB=api
          JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
          JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
          JWT_PASSPHRASE=test
          CORS_ALLOW_ORIGIN='^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$'
          STORAGE_DIR=%kernel.project_dir%/var/storage
          STORAGE_BASE_URL=http://localhost:8080/var/storage
          EOF

      - name: Build and deploy with Skaffold
        run: |
          skaffold run --tail=false --wait-for-connection=true
        timeout-minutes: 15

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for PHP deployment..."
          kubectl wait --for=condition=available --timeout=300s deployment -l app.kubernetes.io/name=pvr,app.kubernetes.io/part-of=pvr

          echo "Waiting for PostgreSQL deployment..."
          kubectl wait --for=condition=available --timeout=300s deployment -l app.kubernetes.io/name=postgres

          echo "Waiting for MongoDB deployment..."
          kubectl wait --for=condition=available --timeout=300s deployment -l app.kubernetes.io/name=mongodb

      - name: Check pod status
        run: |
          echo "=== All Pods ==="
          kubectl get pods -o wide

          echo -e "\n=== Services ==="
          kubectl get svc

          echo -e "\n=== Deployments ==="
          kubectl get deployments

      - name: Get PHP pod name
        id: php-pod
        run: |
          PHP_POD=$(kubectl get pods -l app.kubernetes.io/name=pvr,app.kubernetes.io/part-of=pvr -o jsonpath="{.items[0].metadata.name}")
          echo "pod_name=$PHP_POD" >> $GITHUB_OUTPUT
          echo "PHP Pod: $PHP_POD"

      - name: Check PHP pod logs
        if: always()
        run: |
          kubectl logs ${{ steps.php-pod.outputs.pod_name }} --tail=100 || true

      - name: Test database connectivity
        run: |
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console doctrine:query:sql "SELECT 1"

      - name: Run migrations
        run: |
          echo "Running PostgreSQL migrations..."
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console doctrine:migrations:migrate --no-interaction

          echo "Generating MongoDB proxies..."
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console doctrine:mongodb:generate:proxies

          echo "Running MongoDB migrations..."
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console app:mongo:migrations:execute || true

      - name: Generate JWT keys
        run: |
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console lexik:jwt:generate-keypair --overwrite

      - name: Test application health
        run: |
          # Port-forward in background
          kubectl port-forward svc/pvr 8080:80 &
          PF_PID=$!

          # Wait for port-forward to be ready
          sleep 5

          # Test the application
          echo "Testing application endpoint..."
          curl -f http://localhost:8080/api/example || (echo "Health check failed" && exit 1)

          # Cleanup
          kill $PF_PID || true

      - name: Run smoke tests in pod
        run: |
          echo "Running console commands smoke test..."
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console debug:router
          kubectl exec ${{ steps.php-pod.outputs.pod_name }} -- php bin/console cache:clear

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Deployment describe ==="
          kubectl describe deployment -l app.kubernetes.io/part-of=pvr

          echo -e "\n=== Pod describe ==="
          kubectl describe pod ${{ steps.php-pod.outputs.pod_name }} || true

          echo -e "\n=== Pod logs ==="
          kubectl logs ${{ steps.php-pod.outputs.pod_name }} --tail=200 || true

          echo -e "\n=== Events ==="
          kubectl get events --sort-by='.lastTimestamp'

      - name: Cleanup
        if: always()
        run: |
          skaffold delete || true
          kubectl delete all --all || true
